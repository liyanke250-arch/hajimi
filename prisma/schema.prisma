// ==========================================
// Hajimi GRE é¢˜åº“æ•°æ®åº“ Schema - æœ€ç»ˆç‰ˆ
// è®¾è®¡è€ƒè™‘ï¼š
// 1. æ”¯æŒè¶…é•¿æ–‡æœ¬ï¼ˆéš¾é¢˜è§£æã€å¤§é‡è¯æ±‡ï¼‰
// 2. è‡ªåŠ¨å»é‡å’Œå…³è”
// 3. æ”¯æŒæ‰€æœ‰GREé¢˜å‹ï¼ˆVerbal, Quant, Reading, Writingï¼‰
// 4. å¯æ‰©å±•è‡³360å¥—å®Œæ•´å¥—é¢˜
// åˆ›å»ºæ—¶é—´: 2025-10-05
// ç‰ˆæœ¬: 3.0 - Production Ready
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// æšä¸¾ç±»å‹å®šä¹‰
// ==========================================

enum QuestionType {
  // Verbal Reasoning
  TEXT_COMPLETION          // å¡«ç©ºé¢˜ï¼ˆ1-3ç©ºï¼‰
  SENTENCE_EQUIVALENCE     // å¥å­ç­‰ä»·
  READING_COMPREHENSION    // é˜…è¯»ç†è§£
  
  // Quantitative Reasoning
  QUANTITATIVE_COMPARISON  // æ•°é‡æ¯”è¾ƒ
  MULTIPLE_CHOICE_ONE      // å•é€‰é¢˜
  MULTIPLE_CHOICE_MULTIPLE // å¤šé€‰é¢˜
  NUMERIC_ENTRY           // æ•°å€¼è¾“å…¥
  
  // Analytical Writing
  ISSUE_TASK              // Issueå†™ä½œ
  ARGUMENT_TASK           // Argumentå†™ä½œ
  
  @@map("question_type")
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  
  @@map("difficulty_level")
}

enum TestType {
  PRACTICE         // å•é¢˜ç»ƒä¹ 
  SECTION_TEST     // åˆ†èŠ‚æµ‹è¯•
  FULL_TEST        // å®Œæ•´æ¨¡è€ƒ
  OFFICIAL_TEST    // å®˜æ–¹çœŸé¢˜
  
  @@map("test_type")
}

// ==========================================
// æ ¸å¿ƒè¡¨1: é¢˜ç›®è¡¨ (Questions)
// è®¾è®¡è¦ç‚¹ï¼š
// - ä½¿ç”¨ @db.Text å­˜å‚¨è¶…é•¿å†…å®¹
// - questionType æ”¯æŒæ‰€æœ‰GREé¢˜å‹
// - é€šè¿‡ testSets å…³è”æ”¯æŒå¥—é¢˜
// ==========================================
model Question {
  id        String   @id @default(cuid())
  
  // ä¸šåŠ¡æ ‡è¯†
  uuid      String   @unique
  sourceId  String   @map("source_id")
  version   Float    @default(1.0)
  
  // é¢˜ç›®ç±»å‹ï¼ˆæ”¯æŒæ‰€æœ‰GREé¢˜å‹ï¼‰
  questionType QuestionType @map("question_type")
  
  // é¢˜ç›®å†…å®¹ï¼ˆä½¿ç”¨ @db.Text æ”¯æŒè¶…é•¿å†…å®¹ï¼‰
  questionText    String   @map("question_text") @db.Text
  correctAnswer   String   @map("correct_answer")
  
  // é˜…è¯»ç†è§£ç‰¹æ®Šå­—æ®µ
  passage         String?  @db.Text  // é˜…è¯»æ–‡ç« ï¼ˆå¯èƒ½å¾ˆé•¿ï¼‰
  passageTitle    String?  @map("passage_title")
  
  // æ•°å­¦é¢˜ç‰¹æ®Šå­—æ®µ
  quantityA       String?  @map("quantity_a") @db.Text
  quantityB       String?  @map("quantity_b") @db.Text
  
  // å†™ä½œé¢˜ç‰¹æ®Šå­—æ®µ
  prompt          String?  @db.Text  // å†™ä½œæç¤º
  
  // éš¾åº¦ä¿¡æ¯
  difficultyLevel   DifficultyLevel @map("difficulty_level")
  difficultyScore   Float    @map("difficulty_score")
  sentenceComplexity String  @map("sentence_complexity")
  vocabRarity       String   @map("vocab_rarity")
  logicSubtlety     String   @map("logic_subtlety")
  
  // è§£æå†…å®¹ï¼ˆä½¿ç”¨ Json ç±»å‹ï¼ŒPostgreSQL æ”¯æŒè¶…å¤§JSONï¼‰
  // PostgreSQL çš„ jsonb ç±»å‹ç†è®ºä¸Šå¯å­˜å‚¨ 1GB æ•°æ®
  analysis  Json  @db.JsonB
  
  // å…ƒæ•°æ®
  tags      String[]  // æ ‡ç­¾æ•°ç»„
  
  // å®¡è®¡å­—æ®µ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // å…³è”å…³ç³»
  options       QuestionOption[]
  vocabularies  QuestionVocabulary[]
  testSets      TestSetQuestion[]     // æ”¯æŒå¥—é¢˜
  userPractices UserPractice[]
  
  @@map("questions")
  @@index([uuid])
  @@index([sourceId])
  @@index([questionType])
  @@index([difficultyLevel])
}

// ==========================================
// æ ¸å¿ƒè¡¨2: é€‰é¡¹è¡¨ (Question Options)
// ==========================================
model QuestionOption {
  id         String   @id @default(cuid())
  questionId String   @map("question_id")
  
  choice     String
  text       String   @db.Text  // æ”¯æŒé•¿é€‰é¡¹
  isCorrect  Boolean  @map("is_correct")
  
  // é€‰é¡¹åˆ†æï¼ˆå¯èƒ½å¾ˆé•¿ï¼‰
  analysisText String?  @map("analysis_text") @db.Text
  trapTypes    String[] @map("trap_types")
  
  // å…³è”
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  @@unique([questionId, choice])
  @@map("question_options")
  @@index([questionId])
}

// ==========================================
// æ ¸å¿ƒè¡¨3: è¯æ±‡è¡¨ (Vocabularies)
// è®¾è®¡è¦ç‚¹ï¼š
// - word å­—æ®µ UNIQUE ç¡®ä¿å…¨å±€å”¯ä¸€
// - è‡ªåŠ¨å»é‡é€šè¿‡ upsert å®ç°
// ==========================================
model Vocabulary {
  id       String   @id @default(cuid())
  
  // ä¸šåŠ¡æ ‡è¯†
  uuid     String   @unique
  word     String   @unique  // ğŸ”‘ å…³é”®ï¼šç¡®ä¿å•è¯å”¯ä¸€ï¼Œå®ç°è‡ªåŠ¨å»é‡
  version  Float    @default(1.0)
  
  // åŸºæœ¬ä¿¡æ¯
  phonetic      String?
  definitionCn  String   @map("definition_cn") @db.Text
  
  // è¯æºä¿¡æ¯ï¼ˆJSONå­˜å‚¨ï¼‰
  etymology     Json?    @db.JsonB
  
  // åŒæºè¯ï¼ˆJSONæ•°ç»„ï¼‰
  cognates      Json?    @db.JsonB
  
  // ä¾‹å¥
  exampleSentence     String?  @map("example_sentence") @db.Text
  exampleTranslation  String?  @map("example_translation") @db.Text
  
  // ç»Ÿè®¡ä¿¡æ¯ï¼ˆè‡ªåŠ¨ç»´æŠ¤ï¼‰
  usageCount    Int      @default(0) @map("usage_count")  // å‡ºç°åœ¨å¤šå°‘é“é¢˜ä¸­
  
  // å®¡è®¡å­—æ®µ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // å…³è”
  questions QuestionVocabulary[]
  
  @@map("vocabularies")
  @@index([word])
}

// ==========================================
// å…³è”è¡¨: é¢˜ç›®-è¯æ±‡ (Many-to-Many)
// è®¾è®¡è¦ç‚¹ï¼š
// - é€šè¿‡ @@unique é˜²æ­¢é‡å¤å…³è”
// - onDelete: Cascade ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
// ==========================================
model QuestionVocabulary {
  id           String   @id @default(cuid())
  questionId   String   @map("question_id")
  vocabularyId String   @map("vocabulary_id")
  
  // è¯æ±‡åœ¨é¢˜ç›®ä¸­çš„è§’è‰²
  role         String?  @default("general")  // "stem", "option", "passage"
  
  // å…³è”
  question     Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  vocabulary   Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@unique([questionId, vocabularyId])
  @@map("question_vocabularies")
  @@index([questionId])
  @@index([vocabularyId])
}

// ==========================================
// æ–°å¢è¡¨1: å¥—é¢˜é›†åˆ (Test Sets)
// ç”¨é€”ï¼šç®¡ç†360å¥—å®Œæ•´å¥—é¢˜
// ==========================================
model TestSet {
  id          String   @id @default(cuid())
  
  // å¥—é¢˜æ ‡è¯†
  setId       String   @unique @map("set_id")  // å¦‚: "Official-Test-1"
  name        String
  description String?  @db.Text
  
  // å¥—é¢˜ç±»å‹
  testType    TestType @map("test_type")
  
  // å¥—é¢˜ç»“æ„
  totalSections   Int    @map("total_sections")
  totalQuestions  Int    @map("total_questions")
  timeLimit       Int?   @map("time_limit")  // åˆ†é’Ÿ
  
  // å…ƒæ•°æ®
  isPublished Boolean  @default(false) @map("is_published")
  publishDate DateTime? @map("publish_date")
  
  // å®¡è®¡
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // å…³è”
  questions   TestSetQuestion[]
  
  @@map("test_sets")
  @@index([setId])
  @@index([testType])
}

// ==========================================
// å…³è”è¡¨: å¥—é¢˜-é¢˜ç›® (Many-to-Many)
// è®¾è®¡è¦ç‚¹ï¼š
// - sectionNumber å’Œ questionOrder ç¡®å®šé¢˜ç›®åœ¨å¥—é¢˜ä¸­çš„ä½ç½®
// ==========================================
model TestSetQuestion {
  id          String   @id @default(cuid())
  testSetId   String   @map("test_set_id")
  questionId  String   @map("question_id")
  
  // é¢˜ç›®åœ¨å¥—é¢˜ä¸­çš„ä½ç½®
  sectionNumber  Int   @map("section_number")  // ç¬¬å‡ ä¸ªSection
  questionOrder  Int   @map("question_order")  // Sectionå†…çš„é¢˜å·
  
  // å…³è”
  testSet     TestSet  @relation(fields: [testSetId], references: [id], onDelete: Cascade)
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@unique([testSetId, sectionNumber, questionOrder])
  @@map("test_set_questions")
  @@index([testSetId])
  @@index([questionId])
}

// ==========================================
// æ‰©å±•è¡¨: é˜…è¯»æ–‡ç«  (Reading Passages)
// ç”¨é€”ï¼šç‹¬ç«‹ç®¡ç†é˜…è¯»æ–‡ç« ï¼Œå¤šé“é¢˜å¯å…±äº«åŒä¸€ç¯‡æ–‡ç« 
// ==========================================
model ReadingPassage {
  id          String   @id @default(cuid())
  
  passageId   String   @unique @map("passage_id")
  title       String?
  content     String   @db.Text  // æ–‡ç« å†…å®¹ï¼ˆå¯èƒ½å¾ˆé•¿ï¼‰
  
  // æ–‡ç« å…ƒæ•°æ®
  wordCount   Int?     @map("word_count")
  topic       String?
  difficulty  DifficultyLevel?
  
  // å®¡è®¡
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("reading_passages")
  @@index([passageId])
}

// ==========================================
// ç”¨æˆ·ç›¸å…³è¡¨
// ==========================================
model User {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  username  String?  @unique
  email     String   @unique
  
  targetScore Int?   @map("target_score")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  practices UserPractice[]
  
  @@map("users")
}

model UserPractice {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  questionId String   @map("question_id")
  
  userAnswer String?  @map("user_answer") @db.Text
  isCorrect  Boolean  @map("is_correct")
  timeSpent  Int?     @map("time_spent")
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  @@map("user_practices")
  @@index([userId])
  @@index([questionId])
  @@index([createdAt])
}

// ==========================================
// ç»Ÿè®¡è¡¨ï¼ˆå¯é€‰ï¼‰
// ==========================================
model LogicType {
  id          String   @id @default(cuid())
  officialTag String   @unique @map("official_tag")
  nameCn      String   @map("name_cn")
  description String?  @db.Text
  
  questionCount Int    @default(0) @map("question_count")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("logic_types")
}

model TrapType {
  id          String   @id @default(cuid())
  code        String   @unique
  nameCn      String   @map("name_cn")
  description String?  @db.Text
  
  occurrenceCount Int  @default(0) @map("occurrence_count")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("trap_types")
}

model WordRelation {
  id         String   @id @default(cuid())
  type       String
  conceptCn  String   @map("concept_cn")
  word1      String
  word2      String
  sourceId   String?  @map("source_id")
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  @@map("word_relations")
  @@index([type])
  @@index([word1])
  @@index([word2])
}